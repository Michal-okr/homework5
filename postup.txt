PraktickÃ© cviÄenÃ­ - Lekce 5
[DevOps Engineer]

PoÄet bodÅ¯: 15
Deadline: 05.08.2025

Tento Ãºkol navazuje na domÃ¡cÃ­ Ãºkol z lekce 2, kde jste vytvoÅ™ili Python skript s funkcÃ­ a unit testem. NynÃ­ tento skript zabalÃ­te do Docker kontejneru a nasadÃ­te do AWS ECR.
    **â€¢ ÄŒÃ¡st A (10 bodÅ¯):Â Dockerizace a GitHub Actions pipeline**

    **â€¢ ÄŒÃ¡st B (5 bodÅ¯):Â Terraform ECR repository a nahrÃ¡nÃ­ do AWS ECR**

Pro ECR a terraform budete potÅ™ebovat nastavit AWS credentials vÂ Github Secrets, pokud jste tak jiÅ¾ neuÄinili vÂ lekci 4

ÄŒÃ¡st A: Dockerizace aplikace (10 bodÅ¯)
Krok 1: PÅ™Ã­prava souborÅ¯ z lekce 2
UjistÄ›te se, Å¾e mÃ¡te z lekce 2 tyto soubory:
    **â€¢ calculator.pyÂ (vÃ¡Å¡ Python skript s funkcÃ­)**

    **â€¢ test\_calculator.pyÂ (unit test)**

PÅ™Ã­klad calculator.py:
def scitani(a, b):
    **"""Funkce pro sÄÃ­tÃ¡nÃ­ dvou ÄÃ­sel"""**

    **return a+ b**




def main():
    **result = scitani(5, 3)**

    **print(f"VÃ½sledek: {result}")**




if __name__ == "__main__":
    **main()**

Krok 2: VytvoÅ™enÃ­ Dockerfile
VytvoÅ™te souborÂ DockerfileÂ v root adresÃ¡Å™i:
# PouÅ¾ijeme oficiÃ¡lnÃ­ Python runtime jako zÃ¡klad
FROM python:3.9-slim

# NastavÃ­me pracovnÃ­ adresÃ¡Å™ v kontejneru
WORKDIR /app

# ZkopÃ­rujeme Python soubory do kontejneru
COPY calculator.py .
COPY test_calculator.py .

# SpustÃ­me testy pÅ™i buildu (volitelnÃ©)
RUN python -m unittest test_calculator.py -v

# NastavÃ­me pÅ™Ã­kaz, kterÃ½ se spustÃ­ pÅ™i startu kontejneru
CMD ["python", "calculator.py"]
Krok 3: VytvoÅ™enÃ­ .dockerignore
.git
.github
*.md
__pycache__/
*.pyc
*.pyo
*.pyd
.Python
*.zip
.venv/
venv/
Krok 4: Ãšprava GitHub Actions workflow
VytvoÅ™te nebo upravteÂ .github/workflows/docker-build.yml:
name: Docker Build and Test

on:
push:
    **branches: \[ main, master ]**

pull_request:
    **branches: \[ main, master ]**




env:
IMAGE_NAME: python-calculator

jobs:
build-and-test:
    **runs-on: ubuntu-latest**

    

    **steps:**

    **- name: Checkout repository**

      **uses: actions/checkout@v4**

    

    **- name: Set up Python**

      **uses: actions/setup-python@v4**

      **with:**

        **python-version: '3.9'**

    

    **- name: Run unit tests**

      **run: |**

        **echo "ğŸ§ª SpouÅ¡tÄ›nÃ­ unit testÅ¯..."**

        **python -m unittest test\_calculator.py -v**

    

    **- name: Set up Docker Buildx**

      **uses: docker/setup-buildx-action@v3**

    

    **- name: Build Docker image**

      **run: |**

        **echo "ğŸ³ BuildovÃ¡nÃ­ Docker image..."**

        **docker build -t \\${{ env.IMAGE\_NAME }}:latest .**

        **docker build -t \\${{ env.IMAGE\_NAME }}:\\${{ github.sha }} .**

    

    **- name: Test Docker container**

      **run: |**

        **echo "ğŸš€ TestovÃ¡nÃ­ Docker kontejneru..."**

        **docker run --rm \\${{ env.IMAGE\_NAME }}:latest**

    

    **- name: List Docker images**

      **run: |**

        **echo "ğŸ“‹ Seznam vytvoÅ™enÃ½ch images:"**

        **docker images | grep \\${{ env.IMAGE\_NAME }}**

    

    



Krok 5: LokÃ¡lnÃ­ testovÃ¡nÃ­ (pÅ™ed push)
# 1. Build Docker image
docker build -t python-calculator:latest .

# 2. SpuÅ¡tÄ›nÃ­ kontejneru
docker run --rm python-calculator:latest

# 3. OvÄ›Å™enÃ­ vytvoÅ™enÃ½ch images
docker images | grep python-calculator

# 4. TestovÃ¡nÃ­ interaktivnÄ› (volitelnÃ©)
docker run -it python-calculator:latest /bin/bash

ÄŒÃ¡st B: Terraform a AWS ECR (5 bodÅ¯)
Krok 1: VytvoÅ™enÃ­ Terraform konfigurace
VytvoÅ™te adresÃ¡Å™Â terraform/Â a v nÄ›m tyto soubory:
terraform/main.tf:
terraform {
required_version = ">= 1.0"
required_providers {
    **aws = {**

      **source  = "hashicorp/aws"**

      **version = "~> 5.0"**

    **}**

}
}

provider "aws" {
region = var.aws_region
}

# ECR Repository
resource "aws_ecr_repository" "python_calculator" {
name                 = var.repository_name
image_tag_mutability = "MUTABLE"

image_scanning_configuration {
    **scan\_on\_push = true**

}

tags = {
    **Environment = var.environment**

    **Project     = "DevOps-Course"**

    **Lesson      = "5"**

}
}

# ECR Lifecycle Policy
resource "aws_ecr_lifecycle_policy" "python_calculator_policy" {
repository = aws_ecr_repository.python_calculator.name

policy = jsonencode({
    **rules = \[**

      **{**

        **rulePriority = 1**

        **description  = "Keep last 10 images"**

        **selection = {**

          **tagStatus     = "tagged"**

          **tagPrefixList = \["v"]**

          **countType     = "imageCountMoreThan"**

          **countNumber   = 10**

        **}**

        **action = {**

          **type = "expire"**

        **}**

      **}**

    **]**

})
}
terraform/variables.tf:
variable "aws_region" {
description = "AWS region"
type        = string
default     = "eu-central-1"
}

variable "repository_name" {
description = "Name of the ECR repository"
type        = string
default     = "python-calculator"
}

variable "environment" {
description = "Environment name"
type        = string
default     = "dev"
}
terraform/outputs.tf:
output "ecr_repository_url" {
description = "URL of the ECR repository"
value       = aws_ecr_repository.python_calculator.repository_url
}

output "ecr_repository_arn" {
description = "ARN of the ECR repository"
value       = aws_ecr_repository.python_calculator.arn
}
Krok 2: RozÅ¡Ã­Å™enÃ­ GitHub Actions o ECR deployment
PÅ™idejte doÂ .github/workflows/docker-build.ymlÂ novÃ½ job:
deploy-to-ecr:
    **needs: build-and-test**

    **runs-on: ubuntu-latest**

    **if: github.ref == 'refs/heads/main'**

    

    **steps:**

    **- name: Checkout repository**

      **uses: actions/checkout@v4**

    

    **- name: Configure AWS credentials**

      **uses: aws-actions/configure-aws-credentials@v4**

      **with:**

        **aws-access-key-id: \\${{ secrets.AWS\_ACCESS\_KEY\_ID }}**

        **aws-secret-access-key: \\${{ secrets.AWS\_SECRET\_ACCESS\_KEY }}**

        **aws-region: eu-central-1**

    

    **- name: Setup Terraform**

      **uses: hashicorp/setup-terraform@v3**

      **with:**

        **terraform\_version: 1.5.0**

    

    **- name: Terraform Init**

      **working-directory: ./terraform**

      **run: terraform init**

    

    **- name: Terraform Plan**

      **working-directory: ./terraform**

      **run: terraform plan**

    

    **- name: Terraform Apply**

      **working-directory: ./terraform**

      **run: terraform apply -auto-approve**

    

    **- name: Get ECR repository URL**

      **id: ecr-url**

      **working-directory: ./terraform**

      **run: |**

        **ECR\_URL=\\$(terraform output -raw ecr\_repository\_url)**

        **echo "ecr\_url=\\$ECR\_URL" >> \\$GITHUB\_OUTPUT**

    

    **- name: Login to Amazon ECR**

      **id: login-ecr**

      **uses: aws-actions/amazon-ecr-login@v2**

    

    **- name: Build and push Docker image to ECR**

      **run: |**

        **ECR\_URL=\\${{ steps.ecr-url.outputs.ecr\_url }}**

        **docker build -t \\$ECR\_URL:latest .**

        **docker build -t \\$ECR\_URL:\\${{ github.sha }} .**

        

        **echo " Pushing images to ECR..."**

        **docker push \\$ECR\_URL:latest**

        **docker push \\$ECR\_URL:\\${{ github.sha }}**

        

        **echo " Images pushed successfully!"**

        **echo "Repository URL: \\$ECR\_URL"**

Krok 3: NastavenÃ­ GitHub Secrets
V GitHub repository nastavte tyto secrets:
    **â€¢ AWS\_ACCESS\_KEY\_ID**

    **â€¢ AWS\_SECRET\_ACCESS\_KEY**

Krok 4: LokÃ¡lnÃ­ testovÃ¡nÃ­ Terraform
# 1. PÅ™ejdÄ›te do terraform adresÃ¡Å™e
cd terraform/

# 2. Inicializace Terraform
terraform init

# 3. PlÃ¡novÃ¡nÃ­ zmÄ›n
terraform plan

# 4. AplikovÃ¡nÃ­ zmÄ›n
terraform apply

# 5. ZobrazenÃ­ outputs
terraform output

# 6. Po dokonÄenÃ­ testovÃ¡nÃ­ mÅ¯Å¾ete resources smazat
terraform destroy
Krok 5: ManuÃ¡lnÃ­ push do ECR (pro testovÃ¡nÃ­)
# 1. PÅ™ihlÃ¡Å¡enÃ­ do ECR
aws ecr get-login-password --region eu-central-1 | docker login --username AWS --password-stdin YOUR_ACCOUNT.dkr.ecr.eu-central-1.amazonaws.com

# 2. Tag image pro ECR
docker tag python-calculator:latest YOUR_ACCOUNT.dkr.ecr.eu-central-1.amazonaws.com/python-calculator:latest

# 3. Push do ECR
docker push YOUR_ACCOUNT.dkr.ecr.eu-central-1.amazonaws.com/python-calculator:latest

# 4. OvÄ›Å™enÃ­ v ECR
aws ecr list-images --repository-name python-calculator --region eu-central-1

KontrolnÃ­ seznam pro odevzdÃ¡nÃ­
ÄŒÃ¡st A (10 bodÅ¯):
    **â€¢ Â Dockerfile je vytvoÅ™en a funguje**

    **â€¢ Â .dockerignore je vytvoÅ™en (volitelnÃ©)**

    **â€¢ Â GitHub Actions pipeline builduje Docker image**

    **â€¢ Â Pipeline spouÅ¡tÃ­ unit testy**

    **â€¢ Â Docker kontejner se ÃºspÄ›Å¡nÄ› spustÃ­**

    **â€¢ Â VytvÃ¡Å™Ã­ se zip balÃ­Äek s artifakty**

    **â€¢ Â Screenshot ÃºspÄ›Å¡nÃ© pipeline**

ÄŒÃ¡st B (5 bodÅ¯):
    **â€¢ Â Terraform konfigurace vytvÃ¡Å™Ã­ ECR repository**

    **â€¢ Â GitHub Actions nasazuje do ECR**

    **â€¢ Â Docker image je ÃºspÄ›Å¡nÄ› nahrÃ¡n do ECR**

    **â€¢ Â Terraform outputs ukazujÃ­ ECR URL**

    **â€¢ Â Screenshot ECR repository s nahranÃ½m image**




Tipy a doporuÄenÃ­ (nejen pro Ãºkol, ale i obecnÄ›)
    **1. Testujte lokÃ¡lnÄ›Â pÅ™ed push do GitHub**

    **2. PouÅ¾Ã­vejte malÃ© base imagesÂ (alpine, slim)**

    **3. Nastavte sprÃ¡vnÃ© tagyÂ pro verzovÃ¡nÃ­**

    **4. Sledujte logyÂ GitHub Actions pro debugging**

    **5. PouÅ¾Ã­vejte ECR lifecycle policiesÂ pro sprÃ¡vu starÅ¡Ã­ch images**

ÄŒastÃ© chyby a Å™eÅ¡enÃ­
    **â€¢ Docker build fails: Zkontrolujte syntax Dockerfile**

    **â€¢ ECR push fails: OvÄ›Å™te AWS credentials a permissions**

    **â€¢ Terraform fails: Zkontrolujte AWS provider konfiguraci**

    **â€¢ Tests fail: UjistÄ›te se, Å¾e unit testy z lekce 2 fungujÃ­**

